# H3 Index デモ企画書
## Italy ArcGIS Streamlit アプリケーション

---

## 📋 企画概要

Snowflake の地理空間データデモにおいて、H3 Index（六角形グリッドシステム）の有用性を視聴者に分かりやすく実演するための企画です。イタリアの地理データ（都市、駅、鉄道など）を題材に、H3 Index の基本概念から実用的な分析手法まで、3段階のデモンストレーションを通じて説明します。

---

## 🎯 デモの目的

1. **H3 Index の基本概念の理解**: 六角形グリッドシステムとは何か
2. **実用的な分析手法の実演**: 密度分析、カバレッジ分析など
3. **Snowflake の H3 関数の紹介**: H3_POINT_TO_CELL、H3_CELL_TO_BOUNDARY など
4. **インタラクティブな学習体験**: スライダーやボタンで解像度を変更し、視覚的に理解

---

## 🗺️ デモ構成（3段階）

### **Stage 1: H3 グリッド可視化** - "六角形の世界を見てみよう"

#### 目的
H3 Index の基本概念を視覚的に理解する

#### 実演内容
- イタリア全土または選択した地域を H3 六角形グリッドで覆う
- 解像度（Resolution: 0〜15）をスライダーで調整可能
- 解像度によって六角形のサイズが変わることを視覚的に実演

#### UI デザイン
```
┌─────────────────────────────────────────────────┐
│ H3 Grid Resolution: [━━━━━●━━━━━━] 5            │
│                                                 │
│ [地図表示]                                       │
│ - イタリア全土に六角形グリッド表示              │
│ - 各六角形は薄い青色の境界線                    │
│ - 解像度を変更すると六角形のサイズが変化        │
└─────────────────────────────────────────────────┘
```

#### 使用する Snowflake 関数
```sql
-- 特定地点を H3 セルに変換
H3_POINT_TO_CELL(geography, resolution)

-- H3 セルの境界ポリゴンを取得
H3_CELL_TO_BOUNDARY(h3_cell_id)
```

#### 教育的ポイント
- 「解像度が高いほど、細かい分析ができますが、計算量も増えます」
- 「六角形は正方形より、隣接セルとの距離が均一で、地理分析に適しています」

---

### **Stage 2: 都市密度ヒートマップ** - "イタリアの都市はどこに集まっている？"

#### 目的
H3 Index を使った実用的な密度分析の実演

#### 実演内容
- イタリア全土の都市（places テーブル）を H3 グリッドで集計
- 各六角形内の都市数をカウント
- 密度に応じて色分けしたヒートマップ表示
- 解像度を変更すると、粗い分析 ↔ 詳細分析が切り替わる

#### UI デザイン
```
┌─────────────────────────────────────────────────┐
│ Analysis Type: [● City Density  ○ Station Coverage] │
│ H3 Resolution: [━━━━━●━━━━━━] 5                │
│                                                 │
│ [ヒートマップ表示]                              │
│ - 密度高: 赤色 🔴                                │
│ - 密度中: 黄色 🟡                                │
│ - 密度低: 緑色 🟢                                │
│                                                 │
│ 統計情報:                                       │
│ - Total H3 Cells: 1,234                         │
│ - Max Cities per Cell: 45                       │
│ - Average Cities per Cell: 3.2                  │
└─────────────────────────────────────────────────┘
```

#### 使用する SQL クエリ例
```sql
SELECT
    H3_POINT_TO_CELL(geography, 5) AS h3_cell,
    COUNT(*) AS city_count,
    H3_CELL_TO_BOUNDARY(h3_cell) AS boundary
FROM ITALY_ARCGIS.PUBLIC.PLACES
WHERE type IN ('city', 'town')
GROUP BY h3_cell
ORDER BY city_count DESC
```

#### 教育的ポイント
- 「北イタリア（ミラノ、ヴェネツィア周辺）に都市が集中していることが一目で分かります」
- 「H3 Index を使うと、複雑な地理データを簡単に集計・可視化できます」

---

### **Stage 3: 駅カバレッジ分析** - "鉄道駅はイタリアをどれだけカバーしている？"

#### 目的
H3 Index を使った実用的なカバレッジ分析の実演

#### 実演内容
- 鉄道駅（stations テーブル）を中心に、一定範囲内の H3 セルを抽出
- 「駅から徒歩圏内（例: 1km）」をカバーする H3 セルを可視化
- カバー率を計算し、統計情報を表示

#### UI デザイン
```
┌─────────────────────────────────────────────────┐
│ Coverage Radius: [━━━━━●━━━━━━] 1.0 km         │
│ H3 Resolution: [━━━━━●━━━━━━] 7                │
│                                                 │
│ [カバレッジマップ表示]                          │
│ - カバー済み: 青色 🔵                            │
│ - 未カバー: グレー ⚪                             │
│                                                 │
│ 統計情報:                                       │
│ - Total Stations: 1,856                         │
│ - Covered H3 Cells: 12,345                      │
│ - Coverage Rate: 68.4%                          │
│ - Uncovered Rural Areas: 31.6%                  │
└─────────────────────────────────────────────────┘
```

#### 使用する Snowflake 関数
```sql
-- ポリゴン内の H3 セルを取得
H3_POLYGON_TO_CELLS(geography, resolution)

-- 特定の H3 セルセットのカバレッジ率を計算
H3_COVERAGE(h3_cell_array, total_area)
```

#### 教育的ポイント
- 「都市部は駅のカバレッジが高く、山間部は低いことが分かります」
- 「H3 Index を使うと、『点データ（駅）から面データ（カバレッジエリア）』への変換が簡単にできます」

---

## 🎨 デザインとストーリーテリング

### Before → After の対比演出

**Before（H3 Index を使わない場合）**
- 点データ（駅、都市）だけを地図にプロット
- 密度やカバレッジが直感的に分かりにくい

**After（H3 Index を使った場合）**
- 六角形グリッドで集計・可視化
- 色分けされたヒートマップで一目瞭然

### 視聴者への問いかけ

1. **Stage 1**: 「イタリアを何個の六角形で覆えるでしょうか？」
2. **Stage 2**: 「イタリアで最も都市が密集している地域はどこでしょう？」
3. **Stage 3**: 「イタリア国土の何%が鉄道駅から徒歩圏内でしょうか？」

---

## 🛠️ 実装ロードマップ

### Phase 1: MVP（最小機能）
- ✅ H3 グリッド可視化（Stage 1）
- ✅ 解像度スライダー
- ✅ 基本的な地図表示

### Phase 2: 分析機能追加
- ✅ 都市密度ヒートマップ（Stage 2）
- ✅ 統計情報表示
- ✅ 色分けロジック

### Phase 3: 高度な分析
- ✅ 駅カバレッジ分析（Stage 3）
- ✅ カバレッジ率計算
- ✅ Before/After 比較表示

---

## 📊 期待される成果

1. **視聴者の理解向上**: H3 Index の概念と実用性を視覚的に理解
2. **Snowflake の差別化**: 他のデータウェアハウスにはない地理空間関数の強力さを実演
3. **インタラクティブな体験**: スライダーやボタンで解像度を変更し、リアルタイムで結果を確認
4. **実用的なユースケース**: 都市計画、物流最適化、カバレッジ分析などへの応用可能性を示唆

---

## 🔧 技術スタック

- **Streamlit**: インタラクティブな UI
- **Pydeck**: H3 六角形グリッドの可視化（H3HexagonLayer）
- **Snowflake**: H3 関数による高速な地理空間分析
  - `H3_POINT_TO_CELL`
  - `H3_CELL_TO_BOUNDARY`
  - `H3_POLYGON_TO_CELLS`
  - `H3_COVERAGE`
- **Pandas**: データフレーム操作

---

## 📝 補足事項

### H3 Resolution の目安

| Resolution | 六角形のサイズ | 用途例 |
|-----------|--------------|--------|
| 0-2 | 超広域（国レベル） | 国際比較 |
| 3-5 | 広域（州レベル） | 地域密度分析 |
| 6-8 | 中域（市レベル） | 都市計画 |
| 9-11 | 狭域（地区レベル） | 店舗カバレッジ分析 |
| 12-15 | 超狭域（建物レベル） | 詳細な配送ルート最適化 |

### パフォーマンス考慮事項

- 解像度が高いほど、H3 セル数が増加し、クエリ時間が長くなる
- イタリア全土の分析では、解像度 5-7 が最適
- キャッシュ戦略: 同じ解像度での分析結果を `st.cache_data` でキャッシュ

---

**作成日**: 2025-10-25
**対象アプリケーション**: Italy ArcGIS Streamlit App
**企画者**: Claude (Sonnet 4.5)
